# 쿠버네티스 배포

- RC 혹은 RS를 통해 수행할 수 있는 작업
- Deployment를 통해 자동화할 수 있게 된 작업들 - 별도의 모니터링도 불필요

## 업데이트 원리

- 새로운 컨테이너를 배포하는 경우 일반적으로 블루/그린 배포 & 롤링 업그레이드 방식 중 하나를 사용.

### 블루/그린 배포

- 새로운 RC로 모든 Pod들 새로 생성한 다음에 Service가 이를 가리키도록 설정.

- 블루 버전 : 기존 버전. 업데이트되기 전의 버전.
- 그린 버전 : 최신 버전. 업데이트 후의 버전.

1. 우선 기존에 서비스되고 있던 블루 버전의 Pod들과 RC는 그대로 유지
2. 새로운 Pod 템플릿을 사용하는 새로운 RC를 생성
3. 새로운 RC로 그린 버전의 Pod들 전부 새롭게 배포
4. 그린 버전에 문제가 없으면 Service는 트래픽을 블루에서 그린으로 향하도록 한번에 변경
5. 블루 버전의 Pod들 일괄 제거. 이를 관리하던 기존 RC도 제거

### 롤링 업그레이드

- 개별 Pod를 하나씩 순차적으로 업그레이드하는 방식.

1. 새로운 RC 생성.

   - replica 수는 0으로 시작
   - 새로 생성되는 Pod는 Service에 자동 포함되도록 기존 Pod들과 동일한 라벨명을 지니도록 설정

2. 기존 RC의 replica 수는 1 감소. 새로운 RC의 replica 수는 1 증가.

3. 기존의 Pod들 중 하나는 삭제. 그 자리에 새로운 Pod가 한 개 생성되고 Service에 의해 곧바로 관리됨.

4. 2~3 과정 반복되면서 결과적으로 Service에 존재하던 기존 Pod들은 전부 새로운 Pod들로 대체됨.

---

## 롤백 원리

- 기존 RC의 replica 수를 원래대로 증가시키고,
- 새로운 RC의 replica 수를 0로 지정하면 예전 버전의 Pod들로 롤백됨.

- kubectl rolling-update라는 명령으로 RC 단위로 컨트롤이 가능함.
